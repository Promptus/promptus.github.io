<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Release Dashboard</title>
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css"
        media="screen"
        rel="stylesheet">
  <style>
      tr, td {font-size: 36px}
      h1 {font-size:50px; margin-bottom: 40px;text-align: center}
      .table {font-size: 26px;}
      .date {font-weight:normal; text-align:right;white-space: nowrap;display:none}
      .remaining {font-weight: bold; text-align: center; }
      .testing span, .upcoming span, .ready span {
        font-size: 80%;
        color: #3c763d;
        padding: 5px;
        border: 1px solid white;
        border-radius: 5px;
        color: #3c763d;
        background-color: #dff0d8;
        border-color: #d6e9c6;
        white-space: nowrap;
      }
      

      .table>tbody>tr.ready ~ tr.upcoming>td {
        border-color: #ddd;
        border-width: 5px;
      }

      .table>tbody>tr.upcoming ~ tr.upcoming>td {
        border-color: #ddd;
        border-width: 1px;
      }

      .upcoming span {
        color: #31708f;
        background-color: #d9edf7;
        border-color: #bce8f1;
      }
      
      .ready span {
        color: #8a6d3b;
        background-color: #fcf8e3;
        border-color: #fad17d;
      }
      
      a, a:hover {color: black; text-decoration: none}

      
  </style>
</head>
<body>
  <div class="container-fluid">
    <h1>Release Dashboard</h1>
    <table class="table"
           id="table">
      <tr>
        <th class="date">Feature Freeze</th>
        <th class="">Freeze</th>
        <th class="date">Release</th>
        <th class="">Release</th>
        <th>Sprint</th>
        <th>Resp.</th>
        <th>Status</th>
      </tr>
    </table>
    <div id="boards"></div>
  </div>
  <script crossorigin="anonymous"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        src="https://code.jquery.com/jquery-3.3.1.min.js"></script> 
  <script src="https://api.trello.com/1/client.js?key=ae777dc57a1b37120ed4d508445a1d46"></script> 
  <script type="text/javascript">


    const BOARD_ID_QA = "5aba61edbe1a93f0b27b8735";
    const LIST_ID_UPCOMING = "5abb50892a0be9845d2b6481";
    const LIST_ID_READY = "5abb4fe0c3a47cbdb4645185";
    const LIST_ID_INTEST = "5abb501d79ccc3446d40a403";
    const FEATURE_FREEZE_CUSTOM_FIELD_ID = "5cb716d7d341d74a191a04f6";

    var allCards;
    var boardMembers;
    
   function parseDate(date) {
      var options = { weekday: 'short', month: 'short', day: '2-digit' };
      return new Date(Date.parse(date)).toLocaleDateString("en-EN", options);
   }

   function calculateRemainingDays(date) {
      return Math.round ((  Date.parse(date) - new Date()) / 1000 / 60 / 60 / 24);
   }

    var loadedUpcoming = function(list) {
      $.merge(allCards, list);
      $('.sprintRow').remove();
      $.each(allCards, function(index, card) {
        date = "";
        var daysLeft = "";
        featureFreezeDate = "";
        var ffDaysLeft = "";
        var responsibleMember = "";

        rowClass = "";
        if (card.due) {
          date = parseDate(card.due)
          daysLeft =  calculateRemainingDays(card.due)
        }

        if (card.customFieldItems.find(customField => customField.idCustomField === FEATURE_FREEZE_CUSTOM_FIELD_ID)) {
          console.log(card.customFieldItems)
          const ff = card.customFieldItems.find(customField => customField.idCustomField === FEATURE_FREEZE_CUSTOM_FIELD_ID)
          featureFreezeDate = parseDate(ff.value.date)
          ffDaysLeft =  calculateRemainingDays(ff.value.date)
        }

        if ((daysLeft != "" && daysLeft < 0) || (ffDaysLeft != "" && ffDaysLeft < 0 && card.idList == LIST_ID_UPCOMING)) {
            rowClass = "danger";
          } else if ((daysLeft != "" && daysLeft <= 4) || (ffDaysLeft != "" && ffDaysLeft <= 4  && card.idList == LIST_ID_UPCOMING)) {
            rowClass = "warning";
          }
        
           boardTag = "";

        if (card.idList == LIST_ID_UPCOMING) {
          rowClass += " upcoming"
          boardTag ="Upcoming"
        }  else if (card.idList == LIST_ID_READY) {
          ffDaysLeft = "–"
          featureFreezeDate = ""
          
          rowClass += " ready";
          boardTag = "Ready For Testing";
        } else if (card.idList == LIST_ID_INTEST) {
          ffDaysLeft = "–"
          featureFreezeDate = ""
          
          rowClass += " testing"
          boardTag = "Testing";
        }
        
        if (boardMembers.find(member => member.id === card.idMembers[0])) {
          responsibleMember = boardMembers.find(member => member.id === card.idMembers[0]).initials
        }

        

        $('#table')
        .append("<tr class='sprintRow " + rowClass + "'><td class='date'>" + featureFreezeDate + "<\/td><td class='remaining'>" + ffDaysLeft + "<\/td><td class='date'>" + date + "<\/td><td class='remaining'>" + daysLeft + "<\/td><td><a href='" + card.url + "'>" + card.name + "<\/a><\/td><td>" + responsibleMember + "<\/td><td><span>" + boardTag + "<\/span><\/td><\/tr>");
      });
      setTimeout(function(){
        loadInTest();
      }, 10000)
    };
    
    var loadedReady = function(list) {
      $.merge(allCards, list);
      Trello.get(
        '/lists/' + LIST_ID_UPCOMING + '/cards?customFieldItems=true',
        loadedUpcoming,
        function() { console.log("Failed to load boards"); }
      );
    }
    
    var loadedInTest = function(list) {
      allCards = list;
      Trello.get(
        '/lists/' + LIST_ID_READY + '/cards?customFieldItems=true',
        loadedReady,
        function() { console.log("Failed to load boards"); }
      );
    }
    
    var loadInTest = function() {
      Trello.get(
        '/lists/' + LIST_ID_INTEST + '/cards?customFieldItems=true',
        loadedInTest,
        function() { console.log("Failed to load boards"); }
      );
    }
    
  var loadedMembers= function(members) {
  boardMembers = members;
  loadInTest()
  }

    var loadMembers = function() {
      Trello.get(
        '/boards/' + BOARD_ID_QA + '/members?fields=id,avatarUrl,initials',
        loadedMembers,
        function() { console.log("Failed to load boards"); }
      );
    }

    localStorage.setItem('trello_token', '5628e26a050e09ff933baf555660ae73f4c5ea74d45848e463beb7dfaf0943f1');
    
    Trello.authorize({
      type: "popup",
      name: "Trello dashboard",
      scope: {
        read: true,
        write: false },
      expiration: "never",
      success: loadMembers,
      error: function() { console.log("Failed authentication"); }
    });
  </script>
</body>
</html>
